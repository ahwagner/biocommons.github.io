#!/bin/bash
# Apply consistent branch protections on biocommons repos
# Reece Hart <reecehart@gmail.com>
#
# GitHub's API is a g-d crime scene of bad, broken, and insufficient documentation
# It's like Wumpus, but boring.
#
# Based on https://gist.github.com/edudobay/decc7d772c8a11db130aef9340d392bf?permalink_comment_id=3727261#gistcomment-3727261
# See https://docs.github.com/en/rest/reference/repos#update-branch-protection
# https://stackoverflow.com/questions/55122273/can-i-add-a-new-branch-protection-rule-via-github-api


set -u -o pipefail

if [ "$#" != 3 ]; then
  echo "Usage: $0 owner repo branch" 1>&2
  exit 1
fi

owner="$1"
repo="$2"
branch="$3"
prot_url="https://api.github.com/repos/$owner/$repo/branches/$branch/protection"

# # Show branch protection of $branch branch
# gh api repos/$owner/$repo/branches/$branch/protection  
# 
# # Deletes branch protection of $branch branch
# gh api -X DELETE repos/$owner/$repo/branches/$branch/protection


tmp_fn=/tmp/$owner-$repo-$branch-protection.json

cat <<EOF >$tmp_fn
{
   "allow_deletions": false,
   "allow_force_pushes": false,
   "enforce_admins": true,
   "required_conversation_resolution": false,
   "required_linear_history": false,
   "required_pull_request_reviews": {
      "dismiss_stale_reviews": true,
      "require_code_owner_reviews": true,
      "required_approving_review_count": 1
   },
   "required_status_checks": {
      "checks": [],
      "contexts_url": "https://api.github.com/repos/biocommons/biocommons/branches/main/protection/required_status_checks/contexts",
      "strict": true
   },
   "restrictions": null
}
EOF

gh api \
  --method PUT $prot_url \
  --input $tmp_fn